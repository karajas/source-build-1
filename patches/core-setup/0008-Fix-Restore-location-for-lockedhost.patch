From 45ee2cef2540a4f20d56e9ed9120df8ead8a0728 Mon Sep 17 00:00:00 2001
From: karajas <karajas@microsoft.com>
Date: Fri, 1 Sep 2017 18:19:43 -0400
Subject: [PATCH] Fix Restore location for lockedhost.csproj

---
 src/sharedFramework/lockedhost/lockedhost.csproj |  2 ++
 src/sharedFramework/sharedFramework.proj         | 12 ++++++------
 2 files changed, 8 insertions(+), 6 deletions(-)

diff --git a/src/sharedFramework/lockedhost/lockedhost.csproj b/src/sharedFramework/lockedhost/lockedhost.csproj
index aaf2c49..902a9b4 100644
--- a/src/sharedFramework/lockedhost/lockedhost.csproj
+++ b/src/sharedFramework/lockedhost/lockedhost.csproj
@@ -3,6 +3,8 @@
   <PropertyGroup>
     <GenerateAssemblyInfo>false</GenerateAssemblyInfo>
     <DisableImplicitFrameworkReferences>true</DisableImplicitFrameworkReferences>
+    <CopyBuildOutputToPublishDirectory>false</CopyBuildOutputToPublishDirectory>
+    <CopyOutputSymbolsToPublishDirectory>false</CopyOutputSymbolsToPublishDirectory>
   </PropertyGroup>
 
   <ItemGroup>
diff --git a/src/sharedFramework/sharedFramework.proj b/src/sharedFramework/sharedFramework.proj
index d287053..2aae85d 100644
--- a/src/sharedFramework/sharedFramework.proj
+++ b/src/sharedFramework/sharedFramework.proj
@@ -28,11 +28,11 @@
 
     <RemoveDir Directories="$(SharedFrameworkNameAndVersionRoot)" />
 
-    <Exec Command="$(DotnetRestoreCommand) --source $(PackagesOutDir) $(CommonSharedFrameworkArgs)"
+    <Exec Command="$(DotnetToolCommand) restore --packages $(SharedFrameworkIntermediatePackagesDir) --source $(PackagesOutDir) $(CommonSharedFrameworkArgs)"
           WorkingDirectory="$(SharedFrameworkSourceRoot)" />
 
     <!-- We publish to a sub folder of the PublishRoot so tools like heat and zip can generate folder structures easier. -->
-    <Exec Command="$(DotnetToolCommand) publish --output $(SharedFrameworkNameAndVersionRoot) $(CommonSharedFrameworkArgs)"
+    <Exec Command="$(DotnetToolCommand) publish --output $(SharedFrameworkNameAndVersionRoot) $(CommonSharedFrameworkArgs) /p:PackagesDir=$(SharedFrameworkIntermediatePackagesDir)"
           WorkingDirectory="$(SharedFrameworkSourceRoot)"
           EnvironmentVariables="NUGET_PACKAGES=$(PackagesDir)" />
 
@@ -134,17 +134,17 @@
     <PropertyGroup>
       <LockedHostSourceRoot>$(MSBuildThisFileDirectory)lockedhost</LockedHostSourceRoot>
       <CommonLockedHostArgs>/p:TargetFramework=$(Framework) /p:RuntimeIdentifier=$(PackageTargetRid) /p:HostResolverVersion=$(HostResolverVersion) /p:HostVersion=$(HostVersion)</CommonLockedHostArgs>
+      <LockedCoreHostRestoreCommand>$(DotnetToolCommand) restore --packages $(SharedFrameworkIntermediatePackagesDir) --source $(PackagesOutDir) $(CommonLockedHostArgs)</LockedCoreHostRestoreCommand>
     </PropertyGroup>
 
     <RemoveDir Directories="$(CoreHostLockedDir)" />
 
-    <Exec Command="$(DotnetRestoreCommand) --source $(PackagesOutDir) $(CommonLockedHostArgs)"
-          WorkingDirectory="$(LockedHostSourceRoot)" />
+    <Exec Command="$(LockedCoreHostRestoreCommand)" WorkingDirectory="$(LockedHostSourceRoot)" />
 
 
-    <Exec Command="$(DotnetToolCommand) publish --output $(CoreHostLockedDir) $(CommonLockedHostArgs)"
+    <Exec Command="$(DotnetToolCommand) publish --output $(CoreHostLockedDir) $(CommonLockedHostArgs) /p:PackagesDir=$(SharedFrameworkIntermediatePackagesDir)"
           WorkingDirectory="$(LockedHostSourceRoot)"
           EnvironmentVariables="NUGET_PACKAGES=$(PackagesDir)" />
   </Target>
 
-</Project>
\ No newline at end of file
+</Project>
-- 
1.8.3.1

